<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, user-scalable=no" />
    
    <link rel="stylesheet" href="css/uikit.min.css" />
    <link rel="stylesheet" href="css/main.css" />
    
    <script src="js/uikit.min.js"></script>
    <script src="js/uikit-icons.min.js"></script>

    <script src="js/jquery-3.6.0.min.js"></script>

    <link rel="stylesheet" type="text/css" href="css/datatables.min.css" />
    <script type="text/javascript" src="js/datatables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.7.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.7.1/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.7.1/js/buttons.print.min.js"></script>

    <script src="./js/jquery.datetimepicker.full.min.js"></script>
    <link rel="stylesheet" href="./css/jquery.datetimepicker.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/izitoast/1.4.0/js/iziToast.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/izitoast/1.4.0/css/iziToast.min.css">

    
    <title>Emails masivos</title>
</head>
<body>
    <div>
        <div class="uk-margin-top uk-text-left" style="margin-left: 30px">
            <h5 class="uk-text-bold ">Nro. Registro: <span id="clave-registro"> </span> -  Fecha: <span id="clave-fecha"></span>
            </h5>
        </div>
    </div>
    <div class="uk-flex uk-flex-center uk-flex-middle" uk-height-viewport="offset-top: true">
        <div class="uk-card uk-card-default uk-card-body uk-width-1-3@m uk-text-center">

            <img data-src="img/logo.png" width="200" height="100" alt="logo" class="uk-margin" uk-img>
            
            <div class="uk-column-1-2">
                <div class="uk-width-1-1@s">
                    <div class="uk-margin-small" >
                        <label class="uk-form-label">Fecha <span class="uk-text-danger">*</span></label>
                        <input class="uk-input datepicker uk-form-small" style="text-align: center" type="text" id="fecha" placeholder="Seleccionar">
                    </div>
                </div>
                <div class="uk-width-1-1@s">
                    <div class="uk-margin-small">
                        <label class="uk-form-label">Sociedades<span class="uk-text-danger">*</span></label>   
                        <select class="uk-select uk-form-small" id="sociedades" style="text-align: center">
                          <option value="" selected disabled hidden>Seleccionar</option>
                          <option value="1000">1000</option>
                          <option value="2000">2000</option>
                          <option value="4000">4000</option>
                          <option value="5000">5000</option>
                          <option value="6000">6000</option>
                        </select>                         
                    </div>
                </div>
                
            </div>

            <div class="uk-width-1-1@s pdf" style="margin-top: 30px">
                <label class="uk-form-label">Archivo PDF <span class="uk-text-danger">*</span></label>
                <div uk-margin >
                  <form id="form" enctype="multipart/form-data">
                    <div uk-form-custom="target: true">
                        <input type="file" name="pdf" id="pdf">
                        <input class="uk-input uk-form-small uk-form-width-medium" type="text" placeholder="Seleccionar Archivo" id="pdfInput" disabled>
                    </div>
                    <button class="uk-button uk-button-small uk-button-primary" id="importar" type="submit">Subir</button>
                  </form>
                </div>
            </div>
                

                <div class="uk-width-1-1 observacion" style="margin-top: 40px">
                    <label class="uk-form-label">Observación <span class="uk-text-danger">*</span></label>
                    <textarea class="uk-textarea" rows="3" id="observacion"></textarea>
                </div>


                <div class="uk-alert-danger" id="alert-vacio" uk-alert hidden>
                    <a class="uk-alert-close" uk-close></a>
                    <p class="uk-text-bold">Los campos nombre, apellido, email y usuario son obligatorios.</p>
                </div>               

            <div class="uk-grid-small" uk-grid style="margin-top: 30px">
            <div class="uk-width-1-2@s">
                <div class="uk-margin">
                    <button id="guardar" class="uk-button uk-button-primary">Guardar</button>
                </div>
            </div>
            <div class="uk-width-1-2@s">
                <div class="uk-margin">
                    <button id="cancelar" class="uk-button uk-button-primary">Cancelar</button>
                </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function() {

           
            n =  new Date();                      
            //Año
            y = n.getFullYear();
            //Mes
            m = n.getMonth() + 1;
            //Día
            d = n.getDate();

           const fechaDia = d + "/" + m + "/" + y;

           jQuery.datetimepicker.setLocale('es');

           $( ".datepicker" ).datetimepicker({
              format: 'd/m/Y',
              timepicker: false,
              minDate: 0,
              locale: 'es',
          });
          
          

            let params = new URLSearchParams(location.search);
            var contract = params.get('registro');

            if(contract){

                $("#clave-registro").text(contract)
                $("#clave-fecha").text(fechaDia)

                var formDataContract = {
                        contract : contract
                }

                $.ajax({
                    url: window.location.origin+'/api/registro/allRegistrosById',
                    type: 'POST',
                    data: formDataContract,
                    global: false,
                    success: function (data){ 

                        if(data.data[0].fecha_programada) {
                            $("#fecha").val(data.data[0].fecha_programada)
                        }                
                        $("#pdfInput").val(data.data[0].archivo)
                        $("#sociedades").val(data.data[0].sociedades).trigger('change.select2')
                        $("#observacion").text(data.data[0].observacion)
                    }
                })

            } else {

            n =  new Date();                      
            //Año
            y = n.getFullYear();
            //Mes
            m = n.getMonth() + 1;
            //Día
            d = n.getDate();

           const fechaDia2 = d + "/" + m + "/" + y;

            $("#clave-fecha").text(fechaDia)

            const dataRegistro = {
                usuario_id: localStorage.getItem('id'),
                fecha: fechaDia2
            }

            $.ajax({
                url: window.location.origin+'/api/registro/createRegistroNew',
                type: 'POST',
                data: dataRegistro,
                global: false,
                success: function (data) {                
                    location.href = window.location.origin+'/crear-registro.html?registro='+data.data;
                }
            });
          }
          $("#importar").click(function (e) {
            e.preventDefault();

            var form = $('#form')[0];
            var pdf = $("#pdf").val();

            if (pdf == "") {
              alert("Seleccionar un archivo para importar PDF");
              return;
            }
            

            var formData = new FormData(form);

            formData.append("clave", $("#clave-registro").text())

            $.ajax({
              type: "POST",
              url: window.location.origin+"/api/registro/importar/pdf",
              data: formData,
              processData: false,
              contentType: false,
              success: function (html) {
                iziToast.success({
                  title: 'El archivo PDF se guardo correctamente',
                });
              },
            });
          });

          $("#guardar").click(function (e) {
            e.preventDefault();

            if($("#fecha").val() == "" || 
                $("#pdfInput").val() == "" ||
                $("#observacion").val() == ""){
                    iziToast.warning({
                            title: 'Completar la información obligatoria (*) ',
                        });
                        return;
                }
            
            const info = {
                clave : $("#clave-registro").text(),
                fecha : $("#fecha").val(),
                pdf : $("#pdfInput").val(),
                observacion : $("#observacion").val(),
                estado : 2,
                sociedades: $("#sociedades").val()
            }

            $.ajax({
                type: 'POST',
                url: window.location.origin+"/api/registro/guardar",
                data: info,
                global: false,
                success: function (html) {
                iziToast.success({
                  title: 'El archivo PDF se guardo correctamente',
                });
                location.href = window.location.origin+'/dashboard.html'
              }
            })
          })

          $("#cancelar").click(function(e){
              e.preventDefault();
              let clave = { clave: $("#clave-registro").text()}
              iziToast.question({
                timeout: 20000,
                backgroundColor: '#8cfdfd',
                close: false,
                overlay: true,
                displayMode: 'once',
                id: 'question',
                zindex: 999,
                message: 'Estas seguro de cancelar el registro?',
                position: 'center',
                buttons: [
                    ['<button class="siButton"><b>SI</b></button>', function (instance, toast) {
 
                        instance.hide({ transitionOut: 'fadeOut' }, toast, 'button');

                        $.ajax({
                            url: window.location.origin+"/api/registro/cancelarRegistro",
                            type: 'POST',
                            data: clave,
                            global: false,
                            success: function (data) {
                            location.href = window.location.origin+'/dashboard.html'
                            }
                        })
                    }, true],
                    ['<button class="noButton">NO</button>', function (instance, toast) {
 
                        instance.hide({ transitionOut: 'fadeOut' }, toast, 'button');
 
                    }],
                ],
                onClosing: function(instance, toast, closedBy){
                    console.info('Closing | closedBy: ' + closedBy);
                },
                onClosed: function(instance, toast, closedBy){
                    console.info('Closed | closedBy: ' + closedBy);
                }               
            });
          })
    });
    </script>
</body>
</html>