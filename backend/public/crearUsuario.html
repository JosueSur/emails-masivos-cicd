<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, user-scalable=no" />
    
    <link rel="stylesheet" href="css/uikit.min.css" />
    <link rel="stylesheet" href="css/main.css" />
    
    <script src="js/uikit.min.js"></script>
    <script src="js/uikit-icons.min.js"></script>

    <script src="js/jquery-3.6.0.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/izitoast/1.4.0/js/iziToast.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/izitoast/1.4.0/css/iziToast.min.css">

    
    <title>Emails masivos</title>
</head>
<body>
    <div class="uk-flex uk-flex-center uk-flex-middle" uk-height-viewport="offset-top: true">
        <div class="uk-card uk-card-default uk-card-body uk-width-1-3@m uk-text-center" style="height: 700px">

            <img data-src="img/logo.png" width="60%" height="100" alt="logo" class="uk-margin" uk-img>
            
            <form class="uk-form-stacked uk-padding uk-column-1-1">

                <div class="uk-width-1-1@s">
                    <div class="uk-margin-small">
                        <label class="uk-form-label">Nombre <span class="uk-text-danger">*</span></label>   
                        <input class="uk-input uk-form-small uk-text-center" id="nombre" type="text" >
                    </div>
                </div>

                <div class="uk-width-1-1@s">
                    <div class="uk-margin-small">
                        <label class="uk-form-label">Apellido <span class="uk-text-danger">*</span></label>   
                        <input class="uk-input uk-form-small uk-text-center" id="apellido" type="text">
                    </div>
                </div>

                <div class="uk-width-1-1@s">
                    <div class="uk-margin-small">
                        <label class="uk-form-label">Email <span class="uk-text-danger">*</span></label>   
                        <input class="uk-input uk-form-small uk-text-center" id="email" type="text">
                    </div>
                </div>

                <div class="uk-width-1-1@s">
                    <label class="uk-form-label">Usuario <span class="uk-text-danger">*</span></label>
                    <input class="uk-input uk-form-small uk-text-center" id="usuario" type="text">
                </div>

                <div class="uk-width-1-1@s">
                    <label class="uk-form-label">Rol <span class="uk-text-danger">*</span></label>
                    <select class="uk-select uk-text-center" id="roles"></select>
                </div>


                <div class="uk-alert-danger" id="alert" uk-alert hidden>
                    <a class="uk-alert-close" uk-close></a>
                    <p class="uk-text-bold">Ya existe un usuario con el email ingresado.</p>
                </div>

                <div class="uk-alert-danger" id="alert-vacio" uk-alert hidden>
                    <a class="uk-alert-close" uk-close></a>
                    <p class="uk-text-bold">Los campos nombre, apellido, email y usuario son obligatorios.</p>
                </div>               

                <div class="uk-column-1-2" style="margin-top: 20px">
                    <div class="uk-margin uk-width-1-2@s">
                        <button id="guardar" class="uk-button uk-button-primary" style="width: 130px; height: 40px; text-align: center !important">Guardar</button>
                    </div>
    
                    <div class="uk-margin uk-width-1-2@s">
                        <button id="volver" class="uk-button uk-button-primary" style="width: 130px; height: 40px; text-align: center !important">Volver</button>
                    </div>
                </div>

            </form>
        </div>
    </div>

    <script>
        $(document).ready(function() {

            $("#nombre").val("");
            $("#apellido").val("");
            $("#email").val("");
            $("#usuario").val("");
            $("#roles").val("0").trigger('change.select2');

            $('#volver').click(function (e) {
                e.preventDefault();
                location.href = window.location.origin+"/panel-control.html";
            })

            $.ajax({
                    url: window.location.origin+'/api/users/allRoles',
                    type: 'GET',
                    global: false,
                    success: function (html) {
                        console.log(html)
                        $("#roles").append('<option value="0" selected>Seleccionar</option>');
                        $.each(html.data, function (key, item) {                          
                            if(html.data[0].id == item.id){
                            $("#roles").append('<option value="' + item.id + '">' + item.descripcion + '</option>');
                            $('#roles').val(item.id).trigger('change.select2');
                          }else{
                            $("#roles").append('<option value="' + item.id + '">' + item.descripcion + '</option>');
                          }
                        });
                    }
                });
                    
            $("#guardar").click(function (e) {

                e.preventDefault();

                if($("#nombre").val() == "" ||
                    $("#apellido").val() == "" ||
                    $('#email').val() == "" ||                  
                    $("#usuario").val() == "" ||
                    $('#roles').val() == 0 ) {
                        iziToast.warning({
                            title: 'Completar la información obligatoria (*) ',
                        });
                        return;
                    }

                const nombre = $("#nombre").val();
                const apellido = $("#apellido").val();
                const email = $("#email").val();
                const usuario = $("#usuario").val();
                const rol = $("#roles").val();              

                if (email == '' || usuario == '' || nombre == '' || apellido == ''){
                    $('#alert-vacio').removeAttr('hidden');
                    return;
                }else{
                    $("#alert-vacio").attr("hidden",true);
                    $.ajax({
                        url: window.location.origin+'/api/users/createUser',
                        type: 'POST',
                        data: "nombre=" + nombre + "&apellido=" + apellido + "&email=" + email + "&usuario=" + usuario + "&rol=" + rol,
                        global: false,
                        success: function (data) {
                            console.log('data', data)
                            if(data.data == 'null'){
                                $('#alert').removeAttr('hidden');
                            }else{
                                iziToast.success({
                                title: 'El usuario se cargó correctamente'
                                });
                                $("#nombre").val("");
                                $("#apellido").val("");
                                $("#email").val("");
                                $("#usuario").val("");
                                $("#roles").val(""); 
                            }
                        }
                    });
                }                            
            });
                                 
        });
    </script>
</body>
</html>