<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, user-scalable=no" />

    <link rel="stylesheet" href="css/uikit.min.css" />
    <link rel="stylesheet" href="css/main.css" />

    <script src="js/uikit.min.js"></script>
    <script src="js/uikit-icons.min.js"></script>
    <script src="js/main.js"></script>

    <script src="js/jquery-3.6.0.min.js"></script>

    <link rel="stylesheet" type="text/css" href="css/datatables.min.css" />
    <script type="text/javascript" src="js/datatables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.7.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.7.1/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.7.1/js/buttons.print.min.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <title>Emails masivos</title>
</head>

<body>

    <header class="uk-container uk-container-xlarge">
        <div class="uk-grid-small uk-child-width-expand@s" uk-grid uk-height-viewport="expand: true">
            <div class="uk-card uk-card-default uk-card-body uk-width-expand@m">

                
                <!-- Atajos y Navegacion-->
                <nav class="uk-navbar-container uk-padding-remove-vertical uk-navbar-transparent" uk-navbar>
                    <div class="uk-navbar-left">
                        <a class="uk-navbar-toggle" href="#" uk-toggle="target: #offcanvas-nav">
                            <span uk-navbar-toggle-icon></span> <span class="uk-margin-small-left">Menu</span>
                        </a>
                    </div>
                    <div class="uk-navbar-right">
                        <img data-src="img/logo-min.png" width="150" height="100" alt="logo"
                            class="uk-margin-top uk-margin-bottom" uk-img>
                    </div>
                </nav>

                <div id="offcanvas-nav" uk-offcanvas="overlay: true">
                    <div id="offcanvas-bar" class="uk-offcanvas-bar">

                        <button id="btn-close" class="uk-offcanvas-close" type="button" uk-close></button>

                        <ul class="uk-nav uk-nav-default">
                            <li class="uk-nav-header"> Plataforma de envio de emails masivos</li>
                            <li class="uk-nav-header">Menu Principal</li>
                            <li><a href="dashboard.html">Dashboard</a></li>
                            
                            <li class="uk-nav-header">Configuración</li>
                            
                            <li><a href="index.html"><span class="uk-margin-small-right"
                                        uk-icon="icon: sign-out"></span> Cerrar Sesión</a></li>
                        </ul>

                    </div>
                </div>

                <h1 class="uk-text-center uk-text-bold uk-margin-remove-top titulo">Registro General de emails</h1>

                <div class="uk-text-right">
                    <a class="uk-button uk-button-primary" href="crear-registro.html">Crear Registro</a>
                </div>

                <div>
                    <div class="uk-margin-top uk-text-left">
                        <h5 class="uk-text-bold "><span id="fechaPrograma"></span>
                        </h5>
                    </div>
                </div>

                <table id="registros" class="display uk-text-center" style="width:100%">
                    <thead>
                        <tr>
                            <th>Acción</th>
                            <th>Fecha</th>
                            <th>Fecha programada</th>
                            <th>Archivo</th>
                            <th>Observacion</th>
                            <th>Usuario</th>
                            <th>Estado</th>
                            <th>Sociedades</th>        
                        </tr>
                    </thead>
                </table>
                <div class="uk-margin">
                    <button id="volver" class="uk-button uk-button-primary">Volver</button>
                </div>
            </div>
            
        </div>
        
    </header>

    <script>
        $(document).ready(function() {


            let roleId = localStorage.getItem('roleid')

            n =  new Date();                      
            //Año
            y = n.getFullYear();
            //Mes
            m = n.getMonth() + 1;
            //Día
            d = n.getDate();

           const fechaPrograma = d + "/" + m + "/" + y;

            $("#fechaPrograma").text(fechaPrograma);

            $('#volver').click(function (e) {
                e.preventDefault();
                if(roleId == 1 || roleId == 2) {
                    location.href = window.location.origin+"/panel-control.html";
                } else {
                    location.href = window.location.origin+"/index.html";
                }
            })

            $('#registros').DataTable({
                
                ajax: {
                    url: window.location.origin+'/api/registro/allRegistros',
                    type: 'GET',
                },
                columns: [
                    {  
                        data: "id", render: function (dataField, type, row, meta) {                                                                             
                            if(row.estadoId == 1){                               
                                $(document).on("click", ".modificar-turnos", function(){
                                    const claveRel = $(this).attr("rel");
                                    if(claveRel == dataField){
                                        location.href = window.location.origin+'/crear-registro.html?registro='+dataField;
                                    }
                                });

                                return '<button class="uk-button uk-button-link uk-button-small uk-margin-small-right modificar-turnos" rel="' + dataField + '" disabled><span uk-icon="pencil"></span></button><button class="uk-button uk-button-link uk-button-small eliminar-turnos" rel="' + dataField + '" disabled><span uk-icon="trash"></span></button>';
                            
                            }else{
                                
                                $(document).on("click", ".modificar-turnos", function(){
                                    const claveRel = $(this).attr("rel");
                                    console.log(dataField)
                                    if(claveRel == dataField){
                                        location.href = window.location.origin+'/crear-registro.html?registro='+dataField;
                                    }
                                });

                                $(document).on("click", ".eliminar-turnos", function(){
                                    const claveRel = $(this).attr("rel");
                                    if(claveRel == dataField){
                                        const registroEliminar = {
                                            clave: claveRel
                                        }
                                        $.ajax({
                                            url: window.location.origin+'/api/registro/deleteRegistro',
                                            type: 'POST',
                                            data: registroEliminar,
                                            global: false,
                                            success: function (data) {
                                                console.log('data', data)
                                                location.href = window.location.origin+'/dashboard.html';
                                            }
                                        });
                                    }
                                });
                                
                                return '<button class="uk-button uk-button-link uk-button-small uk-margin-small-right modificar-turnos" rel="' + dataField + '"><span uk-icon="pencil"></span></button><button class="uk-button uk-button-link uk-button-small eliminar-turnos" rel="' + dataField + '"><span uk-icon="trash"></span></button>';
                            } 
                        } 
                    },
                    { data: "fecha_registro" },
                    { data: "fecha_programada"},
                    { data: "archivo" },
                    { data: "observacion" },
                    { data: "usuarioId", render: function(dataField, type, row, meta) {
                        return row.username
                    }},
                    { data: "estadoId", render: function(dataField, type, row, meta) {
                        if(row.estadoId == 1){
                            return "Enviado";
                        } else {
                            return "Pendiente";
                        }
                    }},
                    { data: "sociedades"}                  
                ],
                "dom": 'Bfrtip',
                "buttons": [
                    'excel', 'pdf'
                ],
                "language": {
                    "sProcessing": "Procesando...",
                    "sLengthMenu": "Mostrar _MENU_ registros",
                    "sZeroRecords": "No se encontraron resultados",
                    "sEmptyTable": "Ningún dato disponible",
                    "sInfo": "Se han cargado un total de _TOTAL_ registros",
                    "sInfoEmpty": "Mostrando registros del 0 al 0 de un total de 0 registros",
                    "sInfoFiltered": "(filtrado de un total de _MAX_ registros)",
                    "sInfoPostFix": "",
                    "sSearch": "Búsqueda:",
                    "sUrl": "",
                    "sInfoThousands": ",",
                    "sLoadingRecords": "Cargando...",
                    "oPaginate": {
                        "sFirst": " ",
                        "sLast": " ",
                        "sNext": ">",
                        "sPrevious": "<"
                    },
                    "oAria": {
                        "sSortAscending": ": Activar para ordenar la columna de manera ascendente",
                        "sSortDescending": ": Activar para ordenar la columna de manera descendente"
                    },
                }
            });
        });

    </script>
</body>

</html>